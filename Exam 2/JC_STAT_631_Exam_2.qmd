---
title: "STAT 631 Exam 2"
author: "Jack Cunningham (jgavc@tamu.edu)"
date: 11/08/2024
date-format: short
format:
  pdf:
    include-in-header:
      - text: |
          \usepackage{amsmath}
editor: visual
engine: knitr
---

```{r}
load("Mid2_2024.Rdata")
```

1\)

We begin by using the Fama-French 3 factor model for $R_t$.

First we find $Y_{t}=R_{t}-\mu_f1_n$ which is the excess return. We have the risk free rate from the FF5 data set.

```{r}
Yt= apply(Rt,2, function(x) x - FF5[,6]);dimnames(Yt)[[2]] =syb;
n= dim(Yt)[1]; N= dim(Yt)[2]; p=3

```

Next we fit the FF3-factor model through the following regression:

$$
Y_{t}=\alpha+B^TF_t+e_t
$$

Which has the usual assumptions (expected value of residual = 0 , diagonal residual matrix).

This uses three factors, excess returns on market portfolio, Small minus Big, High minus low. Each is available in the FF5 dataset.

```{r}
Mkt.RF = FF5[,1]
SMB = FF5[,2]
HML = FF5[,3]
fit= lm(Yt~Mkt.RF+SMB+HML);sfit = summary(fit)
```

Now with our fitted model we can find $R^2$ for all 32 asset returns, grabbing it from the summary of each fit:

```{r}
R.Squared = c(); for(i in 1:N) R.Squared[i] = sfit[[i]]$r.squared
```

b\)

To test if the FF3-factor model holds for all 32 assets as a whole we use the Wald test. Our hypothesis is that:

$$
H_0: \alpha=0,H_a:\alpha \neq 0
$$

Where $\alpha$ is the length N vector, the intercept of our model.

To test this we employ the helpful wald.fun function from Factor_Tests from Homework 8:

```{r}
source("FM_Functions.R")
source("Factor_Tests.R")
```

```{r}
Alpha = c()
for(i in 1:N){
  Alpha = rbind(Alpha, sfit[[i]]$coef[1,])
}
alpha = Alpha[,"Estimate"]
m11 = sfit[[1]]$cov.unscaled[1,1]
Sig = 1/n*t(resid(fit))%*%resid(fit)
var.alpha = m11*Sig
wald.fun(est = alpha, est.var = var.alpha, n =  n, p = p)
```

We cannot reject the null hypothesis that the $\alpha$ vector is equal to 0.

c\)

To use the variance-covariance estimate of $R_t$ we use the below:

That:

$$
\hat{\Sigma_R}=\hat{B}^T\hat{\Sigma_F} \hat{B}+diag(\hat{\Sigma}_e)
$$

Then:

```{r}
Bhat = fit$coefficients[-1,]
Sigma.F = var(FF5[,c(-4,-5,-6)])
Sig.R = t(Bhat)%*%Sigma.F%*%Bhat + diag(diag(Sig))
Sig.R[1:5,1:5]
```

d\)

The explicit solution for the minimum variance portfolio, allowing short selling, is below:

$$
w_{min.v}= \frac{\Sigma^{-1}1}{1^T\Sigma^{-1}1}
$$

For this problem we use $\Sigma$ from part c, the weights are as follows:

```{r}
ones = rep(1,N)
IS = solve(Sig.R)
a = as.numeric((t(ones)%*%IS%*%ones))
w.min = 1/a*(IS%*%ones)
w.min
```

e\)

Now for each step we are taking a model based on the return of each portfolio combined and testing if (now a vector with length three) $\alpha$ is equal to 0. In other words:

$$
H_0:\alpha = 0,H_a:\alpha \neq0
$$

To get the returns of the portfolio i. we simply use:

$$
Y_tw_a
$$

So:

```{r}
Y.a = Yt%*%w.min
```

To get the portfolio for ii. we simply take weights equal to 1/32, and perform the same computation:

```{r}
w.b = rep(1/32, 32)
Y.b = Yt %*% w.b
```

To get the portfolio for iii. we take weights equal to R.sq/sum(R.sq) and perform the same calculation:

```{r}
w.c = R.Squared/sum(R.Squared)
Y.c = Yt %*% w.c
```

Now that we have our three returns we bind them together and similarly to part b we start with fitting the FF3 model:

```{r}
Yt.e = cbind(Y.a, Y.b, Y.c)
```

```{r}
fit.e = lm(Yt.e~Mkt.RF+SMB+HML);sfit.e = summary(fit.e)
```

Now that we have fit this model we continue what we did with the wald test, grab our appropriate arguments for the wald function:

```{r}
Alpha.e = c()
for(i in 1:3){
  Alpha.e = rbind(Alpha.e, sfit.e[[i]]$coef[1,])
}
alpha.e = Alpha.e[,"Estimate"]
m11 = sfit.e[[1]]$cov.unscaled[1,1]
Sig.part.e = 1/n*t(resid(fit.e))%*%resid(fit.e)
var.alpha.e = m11*Sig.part.e
wald.fun(est = alpha.e, est.var = var.alpha.e, n =  n, p = p)
```

For these three portfolios we cannot reject the null hypothesis that all three conform to the FF3 factor model.

2\)

a\)

Given the multivariate T distribution which fit is provided by data mt we can find the minimum variance portfolio through a similar formula from before. In fact we have a better estimate of the Covariance matrix from our fit of FF3 model. We extract that better estimate below:

```{r}
Sig.a = Sig.R[syb6,syb6]
Sig.a
```

Now we use the same explicit formula from earlier:

$$
w_{min.v}= \frac{\Sigma^{-1}1}{1^T\Sigma^{-1}1}
$$

```{r}
ones = rep(1,6)
IS = solve(Sig.a)
a = as.numeric((t(ones)%*%IS%*%ones))
w.min.a = 1/a*(IS%*%ones)
w.min.a
```

b\)

First we create the excess return vector, utilizing the center estimate from the multivariate t distribution:

```{r}
mu.f = 4.72/260
m.ex = mt$center - mu.f
m.ex
```

Now we use the explicit formula to solve for this portfolios weights:

```{r}
aT = as.numeric((t(ones)%*%IS%*%m.ex))
w.T = 1/aT*(IS%*%m.ex)
w.T
```

c\)

Now we have Jennifers portfolio. Let's first create the mean, scale vector reflecting this through $Y w$:

```{r}
mean <- .2*mu.f + .3*mt$center%*%w.min.a + .5*mt$center%*% w.T
mean
```

And its scale is:

```{r}
scale_port <- .2*0 + .3* t(w.min.a)%*%mt$scale%*%w.min.a + .5*t(w.T)%*%mt$scale%*%w.T
scale_port
```

We have a portfolio that has a t distribution with the mean, scale values above and nu = 3.48 from the multivariate fit.

To find VAR, ES parametrically we use:\

$$
VaR(\alpha)=-S(\hat{\mu}+\lambda F_{\nu}^{-1}(\alpha))
$$

and:

The longer formula for ES which is:

$$
ES(\alpha) = S(-\mu + \lambda\frac{f_v(F_\nu^{-1}(\alpha))}{\alpha}*\frac{\nu +(F_\nu^{-1}((\alpha))^2}{\nu-1})
$$

which I could compute, but sadly I have run out of time.
